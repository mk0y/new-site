---
import ChevronDown from "../icons/ChevronDown.astro";
import Search from "../icons/Search.astro";
import X from "../icons/X.astro";
import Menu from "../icons/Menu.astro";
import { getCurrentLang, getCurrentTranslations, kebabCase } from "../utils";
const currentLang = getCurrentLang(Astro.url.host);
const i18nData = await getCurrentTranslations(currentLang);
const { type = "white" } = Astro.props;
---

<header
  id="site-header"
  class:list={[
    "fixed w-full z-50 py-4 border-b border-white/20 transition-all duration-300",
    type === "black" ? "bg-black" : "bg-transparent",
  ]}
  style="top: var(--top-header-height, 0);"
>
  <div class="container mx-auto px-4 md:px-6">
    <nav class="flex items-center justify-between">
      <!-- Logo -->
      <a
        href="/"
        class="flex items-center gap-2 text-2xl font-bold text-white hover:text-primary-1a transition-colors"
      >
        <img
          src={import.meta.env.PUBLIC_LOGO_URL}
          alt={import.meta.env.PUBLIC_SITE_NAME}
          class="h-8"
        />
        <span class="text-2xl font-bold"
          >{import.meta.env.PUBLIC_SITE_NAME}</span
        >
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center space-x-8 main-nav">
        <a href="/" class="nav-item text-white hover:text-primary-1a"
          >{i18nData.common.home}</a
        >
        <div class="relative mega-menu-group">
          <button
            class="nav-item flex cursor-pointer items-center gap-0.5 text-white hover:text-primary-1a"
            id="services-menu-button"
            aria-expanded="false"
          >
            {i18nData.common.services}
            <ChevronDown
              classes="mt-0.5 transform transition-transform duration-300 ease-in-out"
            />
          </button>
          <div
            class="fixed hidden w-[90vw] left-1/2 -translate-x-1/2"
            id="services-menu"
            role="menu"
            aria-labelledby="services-menu-button"
            style="top: var(--header-height);"
          >
            <div class="h-4"></div>
            <div
              class:list={[
                "mega-menu backdrop-blur-xl rounded-lg shadow-lg py-8 border border-white/10 grid grid-cols-4 gap-8 px-12",
                type === "black" ? "bg-black/95" : "bg-black/95",
              ]}
            >
              <!-- Software Development Column -->
              <div class="space-y-4">
                <h3 class="text-primary-1a font-semibold text-lg">
                  {i18nData.common.softwareDevelopment}
                </h3>
                <ul class="space-y-2">
                  <li>
                    <a
                      href="/services/custom-software-development"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.customSoftwareDevelopment}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/web-development"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.webDevelopment}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/mobile-development"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.mobileAppDevelopment}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/cloud-development"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.cloudDevelopment}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/api-development"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.apiDevelopment}</a
                    >
                  </li>
                </ul>
              </div>

              <!-- IT Consulting Column -->
              <div class="space-y-4">
                <h3 class="text-primary-1a font-semibold text-lg">
                  {i18nData.common.itConsulting}
                </h3>
                <ul class="space-y-2">
                  <li>
                    <a
                      href="/services/it-strategy"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.itStrategyAndPlanning}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/technology-assessment"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.technologyAssessmentAndSelection}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/infrastructure-consulting"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.infrastructureConsulting}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/cybersecurity-consulting"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.cybersecurityConsulting}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/digital-transformation"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.digitalTransformationConsulting}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/compliance-risk"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.complianceAndRiskManagement}</a
                    >
                  </li>
                </ul>
              </div>

              <!-- Nearshoring Column -->
              <div class="space-y-4">
                <h3 class="text-primary-1a font-semibold text-lg">
                  {i18nData.common.nearshoring}
                </h3>
                <ul class="space-y-2">
                  <li>
                    <a
                      href="/services/dedicated-teams"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.dedicatedDevelopmentTeams}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/project-nearshoring"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.projectBasedNearshoring}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/staff-augmentation"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.staffAugmentation}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/quality-assurance"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.qualityAssuranceAndTesting}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/maintenance-support"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.maintenanceAndSupport}</a
                    >
                  </li>
                </ul>
              </div>

              <!-- AI Development Column -->
              <div class="space-y-4">
                <h3 class="text-primary-1a font-semibold text-lg">
                  {i18nData.common.aiDevelopment}
                </h3>
                <ul class="space-y-2">
                  <li>
                    <a
                      href="/services/machine-learning"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.machineLearningSolutions}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/nlp"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.naturalLanguageProcessing}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/computer-vision"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.computerVisionApplications}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/predictive-analytics"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.predictiveAnalytics}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/ai-chatbots"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.aiPoweredChatbots}</a
                    >
                  </li>
                  <li>
                    <a
                      href="/services/rag"
                      class="text-white/90 hover:text-primary-1a transition-colors text-sm block"
                      >{i18nData.common.ragRetrievalAugmentedGeneration}</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="relative submenu-group">
          <button
            class="nav-item flex cursor-pointer items-center gap-0.5 text-white hover:text-primary-1a"
            id="industries-menu-button"
            aria-expanded="false"
          >
            {i18nData.common.industries}
            <ChevronDown
              classes="mt-0.5 transform transition-transform duration-300 ease-in-out"
            />
          </button>
          <div
            class="fixed hidden w-64 left-1/2 -translate-x-1/2"
            id="industries-menu"
            role="menu"
            aria-labelledby="industries-menu-button"
            style="top: var(--header-height);"
          >
            <div class="h-4"></div>
            <div
              class:list={[
                "backdrop-blur-xl rounded-lg shadow-lg py-2 border border-white/10",
                type === "black" ? "bg-black/95" : "bg-black/95",
              ]}
            >
              <a
                href={`/${kebabCase(i18nData.common.startups)}`}
                class="block px-4 py-2 text-white/90 hover:text-primary-1a hover:bg-white/5 transition-colors text-sm"
              >
                {i18nData.common.startups}
              </a>
              <a
                href={`/${kebabCase(i18nData.common.healthcare)}`}
                class="block px-4 py-2 text-white/90 hover:text-primary-1a hover:bg-white/5 transition-colors text-sm"
              >
                {i18nData.common.healthcare}
              </a>
              <a
                href={`/${kebabCase(i18nData.common.fintech)}`}
                class="block px-4 py-2 text-white/90 hover:text-primary-1a hover:bg-white/5 transition-colors text-sm"
              >
                {i18nData.common.fintech}
              </a>
              <a
                href={`/${kebabCase(i18nData.common.retail)}`}
                class="block px-4 py-2 text-white/90 hover:text-primary-1a hover:bg-white/5 transition-colors text-sm"
              >
                {i18nData.common.retail}
              </a>
              <a
                href={`/${kebabCase(i18nData.common.media)}`}
                class="block px-4 py-2 text-white/90 hover:text-primary-1a hover:bg-white/5 transition-colors text-sm"
              >
                {i18nData.common.media}
              </a>
              <a
                href={`/${kebabCase(i18nData.common.eCommerce)}`}
                class="block px-4 py-2 text-white/90 hover:text-primary-1a hover:bg-white/5 transition-colors text-sm"
              >
                {i18nData.common.eCommerce}
              </a>
              <a
                href={`/${kebabCase(i18nData.common.automotive)}`}
                class="block px-4 py-2 text-white/90 hover:text-primary-1a hover:bg-white/5 transition-colors text-sm"
              >
                {i18nData.common.automotive}
              </a>
              <a
                href={`/${kebabCase(i18nData.common.transportation)}`}
                class="block px-4 py-2 text-white/90 hover:text-primary-1a hover:bg-white/5 transition-colors text-sm"
              >
                {i18nData.common.transportation}
              </a>
            </div>
          </div>
        </div>
        <a
          href="/success-stories"
          class="nav-item text-white hover:text-gray-200 relative z-10"
          >{i18nData.common.aboutUs}</a
        >
        <a
          href="/case-studies"
          class="nav-item text-white hover:text-gray-200 relative z-10"
          >{i18nData.common.caseStudies}</a
        >
        <a
          href="/insights"
          class="nav-item text-white hover:text-gray-200 relative z-10"
          >{i18nData.common.blog}</a
        >
      </div>

      <!-- Language and Search Container -->
      <div class="hidden md:flex items-center space-x-4">
        <!-- Search Component -->
        <div class="relative" id="search-container">
          <button
            class="text-white p-2 hover:text-gray-200 transition-colors"
            id="search-toggle"
          >
            <Search />
          </button>
          <div
            class="absolute right-0 top-full mt-2 hidden"
            id="search-input-container"
          >
            <div
              class="flex items-center bg-white rounded-lg shadow-lg overflow-hidden"
            >
              <input
                type="text"
                placeholder="Search..."
                class="w-64 px-4 py-2 text-gray-800 focus:outline-none"
                id="search-input"
              />
              <button
                class="p-2 text-gray-600 hover:text-gray-800"
                id="search-close"
              >
                <X />
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile Menu Button -->
      <button class="md:hidden text-white" id="mobile-menu-button">
        <Menu />
      </button>
    </nav>

    <!-- Mobile Navigation -->
    <div class="md:hidden hidden" id="mobile-menu">
      <div class="pt-4 pb-3 space-y-3">
        <a href="/" class="block text-white hover:text-gray-200">Home Page</a>
        <a href="/services" class="block text-white hover:text-gray-200"
          >Our Services</a
        >
        <a href="/success-stories" class="block text-white hover:text-gray-200"
          >Success Stories</a
        >
        <button
          class="flex items-center gap-1 text-white hover:text-gray-200 w-full justify-between"
          id="mobile-resources-button"
        >
          Resources
          <ChevronDown
            classes="w-4 h-4 transform transition-transform duration-300 ease-in-out group-hover:rotate-180"
          />
        </button>
        <div class="hidden pl-4 space-y-2 mt-2" id="mobile-resources-menu">
          <div
            class="bg-black/20 backdrop-blur-xl rounded-lg border border-white/10 py-2"
          >
            <a
              href="/blog"
              class="block px-4 py-2 text-white hover:bg-white/10 transition-colors"
              >Blog</a
            >
            <a
              href="/docs"
              class="block px-4 py-2 text-white hover:bg-white/10 transition-colors"
              >Documentation</a
            >
            <a
              href="/guides"
              class="block px-4 py-2 text-white hover:bg-white/10 transition-colors"
              >Guides</a
            >
          </div>
        </div>
        <!-- Mobile Search -->
        <div class="relative mt-4">
          <div class="flex items-center bg-white/10 rounded-lg overflow-hidden">
            <input
              type="text"
              placeholder="Search..."
              class="w-full px-4 py-2 bg-transparent text-white placeholder-gray-300 focus:outline-none"
            />
            <button class="p-2 text-white">
              <Search class="w-5 h-5" />
            </button>
          </div>
        </div>
        <!-- Mobile Language Picker -->
        <div class="mt-4">
          <div class="flex justify-center gap-4">
            <a
              href={import.meta.env.PUBLIC_SITE_URL_EN}
              class="flex items-center space-x-2 px-4 py-2 rounded-md bg-black/20 backdrop-blur-xl border border-white/10 hover:bg-white/10 transition-colors"
            >
              <span class="w-6">🇬🇧</span>
              <span class="text-white">English</span>
            </a>
            <a
              href={import.meta.env.PUBLIC_SITE_URL_DE}
              class="flex items-center space-x-2 px-4 py-2 rounded-md bg-black/20 backdrop-blur-xl border border-white/10 hover:bg-white/10 transition-colors"
            >
              <span class="w-6">🇩🇪</span>
              <span class="text-white">Deutsch</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  const header = document.getElementById("site-header");
  if (header) {
    const headerHeight = header.offsetHeight;
    header.style.height = `${headerHeight}px`;
    document.documentElement.style.setProperty(
      "--header-height",
      `${headerHeight}px`
    );
  }

  // Menu functionality
  const servicesButton = document.getElementById("services-menu-button");
  const servicesMenu = document.getElementById("services-menu");
  const industriesButton = document.getElementById("industries-menu-button");
  const industriesMenu = document.getElementById("industries-menu");

  let activeMenu: HTMLElement | null = null;
  let activeButton: HTMLElement | null = null;

  const closeActiveMenu = () => {
    if (activeMenu && activeButton) {
      activeMenu.classList.add("hidden");
      activeButton.setAttribute("aria-expanded", "false");
      activeButton.querySelector("svg")?.classList.remove("rotate-180");
      activeMenu = null;
      activeButton = null;
    }
  };

  const toggleMenu = (button: HTMLElement, menu: HTMLElement) => {
    const isOpen = !menu.classList.contains("hidden");

    // Close active menu if it's different from the current one
    if (activeMenu && activeMenu !== menu) {
      closeActiveMenu();
    }

    if (isOpen) {
      // Close menu
      menu.classList.add("hidden");
      button.setAttribute("aria-expanded", "false");
      button.querySelector("svg")?.classList.remove("rotate-180");
      activeMenu = null;
      activeButton = null;
    } else {
      // Open menu
      menu.classList.remove("hidden");
      button.setAttribute("aria-expanded", "true");
      button.querySelector("svg")?.classList.add("rotate-180");
      activeMenu = menu;
      activeButton = button;
    }
  };

  // Add click handlers
  servicesButton?.addEventListener("click", (e) => {
    e.stopPropagation();
    if (servicesMenu) toggleMenu(servicesButton, servicesMenu);
  });

  industriesButton?.addEventListener("click", (e) => {
    e.stopPropagation();
    if (industriesMenu) toggleMenu(industriesButton, industriesMenu);
  });

  // Close menus when clicking outside
  document.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    if (
      !target.closest(".mega-menu-group") &&
      !target.closest(".submenu-group")
    ) {
      closeActiveMenu();
    }
  });

  // Close menus on escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeActiveMenu();
    }
  });

  // Mobile menu handlers
  const mobileMenuButton = document.getElementById("mobile-menu-button");
  const mobileMenu = document.getElementById("mobile-menu");
  const mobileResourcesButton = document.getElementById(
    "mobile-resources-button"
  );
  const mobileResourcesMenu = document.getElementById("mobile-resources-menu");

  // Search functionality
  const searchToggle = document.getElementById("search-toggle");
  const searchContainer = document.getElementById("search-container");
  const searchInputContainer = document.getElementById(
    "search-input-container"
  );
  const searchInput = document.getElementById(
    "search-input"
  ) as HTMLInputElement;
  const searchClose = document.getElementById("search-close");

  // Mobile menu handlers
  mobileMenuButton?.addEventListener("click", () => {
    mobileMenu?.classList.toggle("hidden");
  });

  mobileResourcesButton?.addEventListener("click", (e) => {
    const chevron = mobileResourcesButton.querySelector("svg");
    chevron?.classList.toggle("rotate-180");
    mobileResourcesMenu?.classList.toggle("hidden");
  });

  // Handle search toggle with animation
  searchToggle?.addEventListener("click", (e) => {
    e.stopPropagation();
    searchInputContainer?.classList.remove("hidden");
    setTimeout(() => searchInput?.focus(), 100);
  });

  searchClose?.addEventListener("click", (e) => {
    e.stopPropagation();
    if (searchInput) searchInput.value = "";
    searchInputContainer?.classList.add("hidden");
  });

  // Close search on click outside
  document.addEventListener("click", (event) => {
    const target = event.target as HTMLElement;
    if (!searchContainer?.contains(target)) {
      if (searchInput) searchInput.value = "";
      searchInputContainer?.classList.add("hidden");
    }
  });
</script>

<style>
  /* Add backdrop blur when scrolling */
  #site-header {
    position: fixed;
    transition:
      background-color 0.3s ease,
      top 0.3s ease;
    transform: translateY(0);
    z-index: 999;
  }

  #site-header.scrolled {
    background-color: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
  }

  /* Main nav hover effect */
  .nav-item {
    position: relative;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  .nav-item:hover {
    color: #3fcf8d;
    background: rgba(63, 207, 141, 0.1);
    backdrop-filter: blur(8px);
  }

  /* Mega menu animation */
  .mega-menu-group > div {
    opacity: 0;
    visibility: hidden;
    transform: translateY(-12px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
    z-index: 998;
  }

  .mega-menu-group > div:not(.hidden) {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }

  .mega-menu {
    transform-origin: top center;
    box-shadow:
      0 25px 50px -12px rgba(0, 0, 0, 0.35),
      0 0 50px -12px rgba(0, 0, 0, 0.25);
    position: relative;
  }

  .mega-menu::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(
      circle at top,
      rgba(63, 207, 141, 0.05),
      transparent 70%
    );
    pointer-events: none;
    border-radius: 0.5rem;
  }

  .mega-menu a {
    position: relative;
    transition: all 0.2s ease;
  }

  .mega-menu a:hover {
    transform: translateX(4px);
  }

  .mega-menu a::after {
    content: "";
    position: absolute;
    width: 0;
    height: 1px;
    bottom: -2px;
    left: 0;
    background-color: #3fcf8d;
    transition: width 0.2s ease;
  }

  .mega-menu a:hover::after {
    width: 100%;
  }

  /* Industries submenu animation */
  .submenu-group > div {
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }

  .submenu-group > div:not(.hidden) {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }

  /* Resources submenu animation */
  .submenu-group > div {
    opacity: 0;
    visibility: hidden;
    transform: translateY(-5px);
    transition: all 0.2s ease-out;
    pointer-events: none;
  }

  .submenu-group:hover > div {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }

  /* Mobile Resources menu animation */
  #mobile-resources-menu {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 0;
    opacity: 0;
    overflow: hidden;
  }

  #mobile-resources-menu:not(.hidden) {
    max-height: 200px;
    opacity: 1;
  }

  /* Enhanced Search animation */
  #search-input-container {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-20px) scale(0.95);
  }

  #search-input-container:not(.hidden) {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }

  /* Language menu animation */
  #language-menu {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
  }

  #language-menu:not(.hidden) {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  /* Search input animation */
  #search-input {
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 200px;
  }

  #search-input:focus {
    width: 300px;
  }

  /* Mobile search animation */
  .mobile-search-enter {
    animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  // Add backdrop blur to header on scroll
  const header = document.getElementById("site-header");
  window.addEventListener("scroll", () => {
    if (window.scrollY > 50) {
      header?.classList.add("scrolled");
    } else {
      header?.classList.remove("scrolled");
    }
  });
</script>
